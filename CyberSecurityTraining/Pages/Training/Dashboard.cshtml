@page
@model CyberSecurityTraining.Pages.Training.DashboardModel
@using CyberSecurityTraining.Models <!-- // Add the namespace where ProgressStatus is defined -->
@{
    ViewData["Title"] = "Training Dashboard";
}

<div class="breadcrumb">
    Dashboard
</div>

<div class="page-title">Welcome, @(Model.CurrentUser?.FirstName ?? "User")!</div>
<div class="page-subtitle">Continue your cybersecurity training journey</div>

<div class="stats">
    <div class="stat">
        <div class="stat-number">@Model.AssignedModules.Count</div>
        <div class="stat-label">Assigned Modules</div>
        <div class="stat-change">Learning paths</div>
    </div>
    <div class="stat">
        <div class="stat-number">@Model.CompletedModulesCount</div>
        <div class="stat-label">Completed</div>
        <div class="stat-change">Finished courses</div>
    </div>
    <div class="stat">
        <div class="stat-number">@Math.Round(Model.OverallProgress, 1)%</div>
        <div class="stat-label">Overall Progress</div>
        <div class="stat-change">Learning completion</div>
    </div>
    <div class="stat">
        <div class="stat-number">@Model.RecentQuizResults.Count</div>
        <div class="stat-label">Recent Quizzes</div>
        <div class="stat-change">Assessment attempts</div>
    </div>
</div>

<!-- Comprehensive Certificate Section -->
@if (Model.AllModulesCompleted)
{
    <div class="alert alert-success">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong><i class="fas fa-certificate"></i> Cybersecurity Training Certificate</strong>
                <p style="margin: 0.5rem 0 0 0;">Congratulations! You have successfully completed all assigned cybersecurity training modules.</p>
                <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 14px;">
                    Modules Completed: @Model.CompletedModulesCount | Overall Progress: @Math.Round(Model.OverallProgress, 1)%
                </p>
            </div>
            <div>
                @if (Model.HasComprehensiveCertificate)
                {
                    <a asp-page="/Training/Certificate" class="btn btn-success">
                        <i class="fas fa-download"></i> Download Certificate
                    </a>
                }
                else
                {
                    <div style="color: var(--text-light); font-size: 14px;">
                        <i class="fas fa-clock"></i> Certificate being prepared...
                    </div>
                }
            </div>
        </div>
    </div>
}

<div class="content">
    <div>
        <div class="section-title">Your Training Modules</div>
        
        @if (Model.AssignedModules.Any())
        {
            <div class="module-list">
                @foreach (var moduleWithProgress in Model.AssignedModules)
                {
                    <div class="module">
                        <div class="module-header">
                            <div>
                                <div class="module-title">@moduleWithProgress.Module.Title</div>
                                <div class="module-meta">@moduleWithProgress.Module.Description</div>
                                @if (moduleWithProgress.Progress != null)
                                {
                                    <div class="progress-bar" style="margin-top: 1rem;">
                                        <div class="progress-fill" style="width: @(moduleWithProgress.CompletionPercentage)%"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-lighter); margin-top: 0.5rem;">
                                        Status: @moduleWithProgress.Progress.Status | 
                                        Lessons: @moduleWithProgress.Progress.CompletedLessons / @moduleWithProgress.Progress.TotalLessons completed |
                                        @Math.Round(moduleWithProgress.CompletionPercentage, 1)% complete
                                    </div>
                                }
                            </div>
                            <div class="module-progress">
                                @if (moduleWithProgress.Progress?.Status == ProgressStatus.Completed)
                                {
                                    <a asp-page="/Training/TakeModule" asp-route-id="@moduleWithProgress.Module.Id" class="btn btn-outline">
                                        <i class="fas fa-eye"></i> Review
                                    </a>
                                }
                                else if (moduleWithProgress.Progress?.Status == ProgressStatus.InProgress)
                                {
                                    <a asp-page="/Training/TakeModule" asp-route-id="@moduleWithProgress.Module.Id" class="btn">
                                        <i class="fas fa-play"></i> Continue
                                    </a>
                                }
                                else
                                {
                                    <a asp-page="/Training/TakeModule" asp-route-id="@moduleWithProgress.Module.Id" class="btn btn-success">
                                        <i class="fas fa-play"></i> Start
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center" style="padding: 4rem 0;">
                <i class="fas fa-book" style="font-size: 48px; color: var(--text-light); margin-bottom: 1.5rem;"></i>
                <h3>No Training Modules Assigned</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Contact your administrator to get training modules assigned to you.</p>
            </div>
        }
    </div>

    
    <div class="sidebar">
        <div class="section-title">Recent Activity</div>
        
        <div style="margin-bottom: 3rem;">
            <h4 style="font-size: 18px; font-weight: 400; margin-bottom: 1.5rem;">Recent Quiz Results</h4>
            @if (Model.RecentQuizResults.Any())
            {
                <div class="module-list">
                    @foreach (var result in Model.RecentQuizResults)
                    {
                        <div class="module">
                            <div class="module-header">
                                <div>
                                    <div class="module-title">@result.Quiz.Title</div>
                                    <div class="module-meta">@result.Quiz.Lesson.Module.Title</div>
                                </div>
                                <div class="module-progress">
                                    <span style="color: @(result.Passed ? "var(--success)" : "var(--danger)"); font-weight: 500;">
                                        @result.Score%
                                    </span>
                                    <div style="font-size: 12px; color: var(--text-lighter); margin-top: 0.25rem;">
                                        @result.CompletedAt.ToString("MMM dd")
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p style="color: var(--text-light); font-size: 14px;">No quiz results yet.</p>
            }
        </div>
        
        <div>
            <h4 style="font-size: 18px; font-weight: 400; margin-bottom: 1.5rem;">Quick Actions</h4>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <a asp-page="/Account/Profile" class="btn btn-outline">
                    <i class="fas fa-user-edit"></i> Edit Profile
                </a>
                @if (Model.HasComprehensiveCertificate)
                {
                    <a asp-page="/Training/Certificate" class="btn btn-success">
                        <i class="fas fa-certificate"></i> Download Certificate
                    </a>
                }
            </div>
        </div>
    </div>
</div>
