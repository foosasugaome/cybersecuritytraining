@page "/Quizzes/Details/{id:int}"
@model CyberSecurityTraining.Areas.Admin.Pages.Quizzes.DetailsModel
@{
    ViewData["Title"] = "Quiz Details";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-3">
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-page="/Dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-page="/Quizzes/Index">Quizzes</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Quiz.Title</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">@Model.Quiz.Title</h1>
                <div>
                    <span class="badge @(Model.Quiz.IsActive ? "bg-success" : "bg-warning text-dark") me-2">
                        @(Model.Quiz.IsActive ? "Active" : "Inactive")
                    </span>
                    <span class="badge bg-info">@Model.Quiz.PassingScore% to pass</span>
                </div>
            </div>

            <!-- Navigation Pills -->
            <ul class="nav nav-pills mb-4" id="quizTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-info-circle me-1"></i>Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="questions-tab" data-bs-toggle="pill" data-bs-target="#questions" type="button" role="tab">
                        <i class="fas fa-question-circle me-1"></i>Questions <span class="badge bg-secondary ms-1">@Model.TotalQuestions</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="statistics-tab" data-bs-toggle="pill" data-bs-target="#statistics" type="button" role="tab">
                        <i class="fas fa-chart-bar me-1"></i>Statistics
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="quizTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Quiz Information</h5>
                                </div>
                                <div class="card-body">
                                    <dl class="row">
                                        <dt class="col-sm-3">Module:</dt>
                                        <dd class="col-sm-9">
                                            <a asp-area="Admin" asp-page="/Modules/Details" asp-route-id="@Model.Quiz.Lesson.ModuleId" class="text-decoration-none">
                                                @Model.Quiz.Lesson.Module.Title
                                            </a>
                                        </dd>

                                        <dt class="col-sm-3">Lesson:</dt>
                                        <dd class="col-sm-9">
                                            <a asp-area="Admin" asp-page="/Lessons/Details" asp-route-id="@Model.Quiz.LessonId" class="text-decoration-none">
                                                @Model.Quiz.Lesson.Title
                                            </a>
                                        </dd>

                                        <dt class="col-sm-3">Description:</dt>
                                        <dd class="col-sm-9">@(Model.Quiz.Description ?? "No description provided")</dd>

                                        <dt class="col-sm-3">Passing Score:</dt>
                                        <dd class="col-sm-9">
                                            <span class="badge bg-primary">@Model.Quiz.PassingScore%</span>
                                        </dd>

                                        <dt class="col-sm-3">Status:</dt>
                                        <dd class="col-sm-9">
                                            <span class="badge @(Model.Quiz.IsActive ? "bg-success" : "bg-warning text-dark")">
                                                @(Model.Quiz.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </dd>

                                        <dt class="col-sm-3">Created:</dt>
                                        <dd class="col-sm-9">@Model.Quiz.DateCreated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>

                                        @if (Model.Quiz.DateModified.HasValue)
                                        {
                                            <dt class="col-sm-3">Last Updated:</dt>
                                            <dd class="col-sm-9">@Model.Quiz.DateModified.Value.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>
                                        }
                                    </dl>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Quick Stats</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h4 class="text-primary">@Model.TotalQuestions</h4>
                                                <small class="text-muted">Questions</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-info">@Model.TotalOptions</h4>
                                            <small class="text-muted">Answer Options</small>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h4 class="text-warning">@Model.UsersAttempted</h4>
                                                <small class="text-muted">Attempts</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success">@Model.UsersCompleted</h4>
                                            <small class="text-muted">Completed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <a asp-area="Admin" asp-page="./Edit" asp-route-id="@Model.Quiz.Id" class="btn btn-primary">
                                            <i class="fas fa-edit me-1"></i>Edit Quiz
                                        </a>
                                        @if (Model.TotalQuestions == 0)
                                        {
                                            <a asp-area="Admin" asp-page="/Questions/Create" asp-route-quizId="@Model.Quiz.Id" class="btn btn-success">
                                                <i class="fas fa-plus me-1"></i>Add First Question
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-area="Admin" asp-page="/Questions/Create" asp-route-quizId="@Model.Quiz.Id" class="btn btn-outline-success">
                                                <i class="fas fa-plus me-1"></i>Add Question
                                            </a>
                                        }
                                        <form method="post" asp-page-handler="ToggleStatus" asp-route-id="@Model.Quiz.Id" class="d-inline">
                                            <button type="submit" class="btn @(Model.Quiz.IsActive ? "btn-outline-warning" : "btn-outline-success") w-100">
                                                <i class="fas @(Model.Quiz.IsActive ? "fa-pause" : "fa-play") me-1"></i>
                                                @(Model.Quiz.IsActive ? "Deactivate" : "Activate")
                                            </button>
                                        </form>
                                        <a asp-area="Admin" asp-page="./Index" class="btn btn-outline-secondary">
                                            <i class="fas fa-list me-1"></i>Back to Quizzes
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Tab -->
                <div class="tab-pane fade" id="questions" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Quiz Questions</h5>
                        <a asp-area="Admin" asp-page="/Questions/Create" asp-route-quizId="@Model.Quiz.Id" class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Add Question
                        </a>
                    </div>

                    @if (Model.Questions.Any())
                    {
                        <div class="accordion" id="questionsAccordion">
                            @for (int i = 0; i < Model.Questions.Count; i++)
                            {
                                var question = Model.Questions[i];
                                var collapseId = $"question{question.Id}";
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading@(question.Id)">
                                        <button class="accordion-button @(i == 0 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                <span>
                                                    <strong>Question @question.Order:</strong> 
                                                    @(question.Text.Length > 80 ? question.Text.Substring(0, 80) + "..." : question.Text)
                                                </span>
                                                <span class="badge bg-info">@question.Options.Count options</span>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="@collapseId" class="accordion-collapse collapse @(i == 0 ? "show" : "")" data-bs-parent="#questionsAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6>Question Text:</h6>
                                                    <p>@question.Text</p>
                                                    
                                                    <h6 class="mt-3">Answer Options:</h6>
                                                    <div class="list-group">
                                                        @foreach (var option in question.Options.OrderBy(o => o.Order))
                                                        {
                                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                                <span>
                                                                    <strong>@option.Order.</strong> @option.Text
                                                                </span>
                                                                @if (option.IsCorrect)
                                                                {
                                                                    <span class="badge bg-success">Correct</span>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="d-grid gap-2">
                                                        <a asp-area="Admin" asp-page="/Questions/Edit" asp-route-id="@question.Id" class="btn btn-outline-secondary btn-sm">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a asp-area="Admin" asp-page="/Questions/Delete" asp-route-id="@question.Id" class="btn btn-outline-secondary btn-sm">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No questions have been added to this quiz yet.</p>
                            <a asp-area="Admin" asp-page="/Questions/Create" asp-route-quizId="@Model.Quiz.Id" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Create First Question
                            </a>
                        </div>
                    }
                </div>

                <!-- Statistics Tab -->
                <div class="tab-pane fade" id="statistics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Performance Overview</h5>
                                </div>
                                <div class="card-body">
                                    @if (Model.UsersAttempted > 0)
                                    {
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <h3 class="text-primary">@Model.UsersAttempted</h3>
                                                <p class="text-muted">Total Attempts</p>
                                            </div>
                                            <div class="col-4">
                                                <h3 class="text-success">@Model.UsersCompleted</h3>
                                                <p class="text-muted">Completed</p>
                                            </div>
                                            <div class="col-4">
                                                <h3 class="text-warning">@(Model.AverageScore.ToString("F1"))%</h3>
                                                <p class="text-muted">Avg Score</p>
                                            </div>
                                        </div>
                                        
                                        @if (Model.UsersCompleted > 0)
                                        {
                                            var completionRate = (double)Model.UsersCompleted / Model.UsersAttempted * 100;
                                            <div class="mt-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Completion Rate</span>
                                                    <span>@(completionRate.ToString("F1"))%</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: @(completionRate)%"></div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center py-4">
                                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">No quiz attempts yet.</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Quiz Health</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="fas fa-question-circle me-2"></i>Questions
                                            </span>
                                            @if (Model.TotalQuestions >= 3)
                                            {
                                                <span class="badge bg-success">@Model.TotalQuestions</span>
                                            }
                                            else if (Model.TotalQuestions > 0)
                                            {
                                                <span class="badge bg-warning">@Model.TotalQuestions</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">0</span>
                                            }
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="fas fa-list me-2"></i>Answer Options
                                            </span>
                                            <span class="badge bg-info">@Model.TotalOptions</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="fas fa-target me-2"></i>Passing Score
                                            </span>
                                            <span class="badge bg-primary">@Model.Quiz.PassingScore%</span>
                                        </div>
                                    </div>
                                    
                                    @if (Model.TotalQuestions < 3)
                                    {
                                        <div class="alert alert-warning mt-3" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Consider adding more questions for a comprehensive assessment.
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
